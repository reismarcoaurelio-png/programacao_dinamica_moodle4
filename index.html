<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Produção Discreta - DP com Lotes</title>
<style>
body{font-family:Arial, sans-serif;padding:18px;background:#f7f9fb;color:#111}
h1{font-size:22px;margin-bottom:12px}
.input-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
input[type="number"], input[type="text"]{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;width:60px;text-align:right}
input[type="text"]{width:200px;text-align:left;text-align:start}
button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;background:#2563eb;color:white}
table{border-collapse:collapse;margin-top:12px}
th,td{border:1px solid #999;padding:6px;text-align:right}
td.correct{background:#dcfce7;color:#065f46}
td.wrong{background:#fee2e2;color:#9b1c1c}
.status{padding:8px;border-radius:6px;margin-top:10px}
.ok{background:#dcfce7;color:#065f46}
.error{background:#fee2e2;color:#9b1c1c}
</style>
</head>
<body>

<h1>Produção Discreta - DP com Lotes (Estoque Final Possível)</h1>

<div class="input-row">
<label>Aluno:</label>
<input id="studentName" type="text" placeholder="Digite seu nome"/>
<label>Períodos (n):</label>
<input id="nPeriods" type="number" value="3" min="1"/>
<label>Estoque máximo (Q):</label>
<input id="maxStock" type="number" value="2000" min="1"/>
<button id="build">Gerar Períodos</button>
</div>

<div id="formArea"></div>
<div id="tableArea"></div>
<div id="feedback" class="status">Preencha demandas, custos e lotes, depois clique em Criar Tabela DP.</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let problem=null, optimalCost=null, possibleStocks=[];

// --- Gerar inputs ---
function renderForm(){
  const n = +document.getElementById('nPeriods').value;
  const form = document.getElementById('formArea');
  form.innerHTML='<strong>Insira demanda, custos e lotes permitidos:</strong><br/>';
  for(let i=0;i<n;i++){
    const row = document.createElement('div');
    row.className='input-row';
    row.innerHTML = `Período ${i+1}: Demanda <input type="number" id="d_${i}" value="500"/> 
    Custo Produção <input type="number" id="c_${i}" value="2"/> 
    Custo Estoque <input type="number" id="h_${i}" value="1"/> 
    Lotes (separados por vírgula) <input type="text" id="l_${i}" value="0,500,1000"/>`;
    form.appendChild(row);
  }
  const btn = document.createElement('button');
  btn.innerText='Criar Tabela DP';
  btn.addEventListener('click', buildTable);
  form.appendChild(btn);
  document.getElementById('tableArea').innerHTML='';
  document.getElementById('feedback').innerText='Agora você pode preencher a tabela DP manualmente.';
}

// --- Ler problema ---
function readProblem(){
  const n = +document.getElementById('nPeriods').value;
  const Q = +document.getElementById('maxStock').value;
  const demand=[], prodCost=[], holdCost=[], lots=[];
  for(let i=0;i<n;i++){
    demand.push(+document.getElementById(`d_${i}`).value);
    prodCost.push(+document.getElementById(`c_${i}`).value);
    holdCost.push(+document.getElementById(`h_${i}`).value);
    lots.push(document.getElementById(`l_${i}`).value.split(',').map(Number));
  }
  return {n,Q,demand,prodCost,holdCost,lots};
}

// --- Construir DP e armazenar custos ótimos ---
function buildTable(){
  problem = readProblem();
  const {n,Q,demand,prodCost,holdCost,lots} = problem;
  
  // Inicialização
  const dp = Array.from({length:n+1},()=>Array(Q+1).fill(Infinity));
  dp[0][0]=0;
  possibleStocks = [new Set([0])]; // Estoques possíveis por período

  for(let t=1;t<=n;t++){
    const stockSet = new Set();
    for(const sPrev of possibleStocks[t-1]){
      for(const x of lots[t-1]){
        const sFinal = sPrev + x - demand[t-1];
        if(sFinal>=0 && sFinal<=Q){
          const cost = dp[t-1][sPrev] + x*prodCost[t-1] + sFinal*holdCost[t-1];
          if(dp[t][sFinal]===Infinity || cost<dp[t][sFinal]){
            dp[t][sFinal]=cost;
          }
          stockSet.add(sFinal);
        }
      }
    }
    possibleStocks.push(stockSet);
  }

  optimalCost = dp;
  renderStudentTable();
}

// --- Renderizar tabela com apenas estoques possíveis ---
function renderStudentTable(){
  const {n} = problem;
  const container = document.getElementById('tableArea');
  container.innerHTML='<strong>Preencha os custos mínimos para cada estoque final possível:</strong>';
  const tbl = document.createElement('table');
  const thead = document.createElement('thead');
  const htr = document.createElement('tr');
  htr.appendChild(document.createElement('th'));
  for(const s of Array.from(possibleStocks[1]).sort((a,b)=>a-b)){
    const th = document.createElement('th'); th.innerText=s;
    th.dataset.s=s;
    htr.appendChild(th);
  }
  thead.appendChild(htr);
  tbl.appendChild(thead);

  const tbody = document.createElement('tbody');
  for(let t=1;t<=n;t++){
    const tr = document.createElement('tr');
    const td0 = document.createElement('td'); td0.innerText=`Período ${t}`; tr.appendChild(td0);
    const stocks = Array.from(possibleStocks[t]).sort((a,b)=>a-b);
    for(const s of stocks){
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type='number'; input.style.width='60px';
      input.dataset.t=t; input.dataset.s=s;
      td.appendChild(input);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);
  container.appendChild(tbl);

  const btnCheck = document.createElement('button');
  btnCheck.innerText='Verificar Custos';
  btnCheck.style.marginTop='10px';
  btnCheck.addEventListener('click', checkTable);
  container.appendChild(btnCheck);
}

// --- Verificar respostas ---
function checkTable(){
  const studentName = document.getElementById('studentName').value.trim();
  if(!studentName){ alert('Digite o nome do aluno!'); return; }

  const inputs = document.querySelectorAll('#tableArea input[type="number"]');
  let correctCount=0;

  inputs.forEach(inp=>{
    const t = +inp.dataset.t;
    const s = +inp.dataset.s;
    const val = +inp.value;
    if(optimalCost[t][s] === val){
      correctCount++;
      inp.parentElement.className='correct';
    } else {
      inp.parentElement.className='wrong';
    }
  });

  const totalCells = inputs.length;
  const score = Math.round((correctCount/totalCells)*100);
  const fb = document.getElementById('feedback');
  fb.innerText = score===100? `✅ Parabéns, ${studentName}! Todos os custos corretos. Nota: ${score}/100`:
                             `❌ Alguns custos incorretos. Nota: ${score}/100`;
  fb.className = score===100?'status ok':'status error';
  addDownloadButton(studentName, score, correctCount, totalCells);
}

// --- Botão PDF ---
function addDownloadButton(name, score, correct, total){
  const existingBtn = document.getElementById('downloadPDF');
  if(existingBtn) existingBtn.remove();
  const btn = document.createElement('button');
  btn.id='downloadPDF';
  btn.innerText='Baixar Relatório em PDF';
  btn.style.marginTop='10px';
  btn.addEventListener('click', ()=>{
    generatePDF(name, score, correct, total);
  });
  document.getElementById('tableArea').appendChild(btn);
}

// --- Gerar PDF ---
function generatePDF(name, score, correct, total){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text('Relatório de Desempenho - Produção Discreta', 20, 20);
  doc.setFontSize(12);
  doc.text(`Aluno: ${name}`, 20, 35);
  doc.text(`Nota: ${score}/100`, 20, 45);
  doc.text(`Células corretas: ${correct} de ${total}`, 20, 55);
  doc.text('Células corretas aparecem em verde e incorretas em vermelho.', 20, 65);
  doc.save(`Relatorio_${name.replace(/\s+/g,'_')}.pdf`);
}

document.getElementById('build').addEventListener('click', renderForm);
</script>
</body>
</html>
